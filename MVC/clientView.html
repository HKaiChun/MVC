<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="https://unpkg.com/vue@next"></script>
</head>

<body >

<div id="main">
<div id="list" v-if="UI=='main'">
	<h1>商品清單</h1>
	<table border=1>
		<tr><td>序號</td><td>商品名稱</td><td>單價</td><td>商品說明</td><td>-</td></tr>
		<tr v-for="pro in dat">
			<td>{{pro.id}}</td>
			<td>{{pro.pName}}</td>
			<td>{{pro.price}}</td>
			<td>{{pro.description}}</td>
			<td><button @click="setQanUI(pro)">加入購物車</button></td>
		</tr>
		<button @click="setUI1('editForm')">查看購物車</button>
	</table>
</div>

<div v-if="UI=='editForm'">
	<h1>我的購物車</h1>
	<button @click="setUI('main')">返回商品清單</button>
	<table border=1>
	<tr><td>序號</td><td>商品名稱</td><td>單價</td><td>商品說明</td>
		<td>數量</td><td>總價</td>
		<td>-</td>
	</tr>
	<tr v-for="pro in dat">
		<td>{{pro.id}}</td>
		<td>{{pro.pName}}</td>
		<td>{{pro.price}}</td>
		<td>{{pro.description}}</td>
		<td>{{pro.num}}</td>
		<td>{{pro.total}}</td>
		<td><button @click="delJob(pro.id)">刪</button></td>
	</tr>
</table>
<p>總價:<span id="totalPrice"></span></p>
</div>
<div v-if="UI=='editForm2'">
	商品名稱: {{newPro.pName}} <br/>

	單價: {{newPro.price}} <br>

	商品說明: {{newPro.description}}<br>
	
	數量: <input type="text" v-model="newPro.num"><br>

	<input type='button' @click="addJob(pro)" value="save">
</div>
</div>

<script>
const todoApp= Vue.createApp({
	data() {
		return {
			UI: 'main',// 表示當前的介面，初始為 'main'
			dat: [],// 存放購物清單數據的陣列
			newPro: {// 新增或編輯專案或購物清單時的預設數據
				id: -1,
				pName: '',
				price: '',
				description: '',
				num: 0,
				total: 0
			}
		}
	},
	watch: {
        UI(newUI) {
            if (newUI === 'editForm') {
                // Only fetch the total price when UI is 'editForm'
                this.fetchTotalPrice();
                // Set up an interval to keep fetching the total price
                this.totalPriceInterval = setInterval(this.fetchTotalPrice, 3000);
            } else {
                // Clear the interval when UI is not 'editForm'
                clearInterval(this.totalPriceInterval);
            }
        },
    },
	methods: {
		loadList: function () {
			const that=this; //this  ==> stands for vm6. let's save `this` to `that`
			fetch('ManagementControll.php?act=listPro') // 使用 fetch 發送 GET 請求獲取列表
			.then(function(response) {
				return response.json();
			})
			.then(function(myJson) {
				//we are inside the callback function, now `this` means the function, not vm6
				//we will use `that` to access vm6
				that.dat = myJson;
				//vm6.dat = myJson;
			});
		},
		loadshoppingList: function () {
			const that=this; //this  ==> stands for vm6. let's save `this` to `that`//// 將 this 保存到 that 中
			fetch('ManagementControll.php?act=listshopping') // 使用 fetch 發送 GET 請求獲取購物清單
			.then(function(response) {
				return response.json();
			})
			.then(function(myJson) {
				//we are inside the callback function, now `this` means the function, not vm6
				//we will use `that` to access vm6
				that.dat = myJson;
				//vm6.dat = myJson;
			});
		},
		delPro: function (id) {//刪除表格
			const that=this;
			let url="ManagementControll.php?act=delPro&id="+id; // 構建包含ID的URL，並以 POST 方法發送到指定的 URL
			fetch(url,{
				method: 'POST'
			})
			.then(function(res){return res.text(); }) //取得傳回值，轉為文字
			.then(function(data){
				console.log(data);// 輸出傳回的數據到控制台
				that.setUI1('editForm');
				//that.loadshoppingList();
			})
		},
		addPro: function () {//新增商品的方法
			const that=this;
			let mydat = new FormData();// 使用 FormData 包裝購物車數據，並以 POST 方法發送到指定的 URL
			mydat.append( "dat", JSON.stringify(this.newPro) );

			let url="ManagementControll.php?act=addnum";
			fetch(url,{
				method: 'POST',
				body: mydat // 將表單物件放入fetch的body屬性
			})
			.then(function(res){return res.text(); }) //取得傳回值，轉為文字
			.then(function(data){ 
				console.log(data);
				that.setUI('main');
				//that.loadList();
			})
		},
		addJob: function () {
			const that=this;
			let mydat = new FormData();
			mydat.append( "dat", JSON.stringify(this.newPro) );

			let url="ManagementControll.php?act=addJob";
			fetch(url,{
				method: 'POST',
				body: mydat // 將表單物件放入fetch的body屬性
			})
			.then(function(res){return res.text(); }) //取得傳回值，轉為文字
			.then(function(data){ 
				console.log(data);
				that.setUI('main');
				//that.loadList();
			})
		},
		delJob: function (id) {
			const that=this;
			let url="ManagementControll.php?act=delJob&id="+id;
			fetch(url,{
				method: 'POST'
			})
			.then(function(res){return res.text(); }) //取得傳回值，轉為文字
			.then(function(data){
				console.log(data);
				that.setUI1('editForm');
				//that.loadshoppingList();
			})
		},
<<<<<<< HEAD
		fetchTotalPrice: function() {
			const that = this;
			let url="ManagementControll.php?act=countP";
			fetch(url, {
				method: 'POST'
			})
			.then(response => response.text())
			.then(data => {
				document.getElementById('totalPrice').innerText = data;
			})
			.catch(error => {
				console.error('Error fetch total price', error);
			})
		},
		setQanUI: function(pro) {
=======
		setQanUI: function(pro) { // 設置編輯介面的方法
>>>>>>> 5d68c5a3aa31f80b5a322f5b09a0c7d0a3d09147
			this.newPro=pro;
			this.setUI('editForm2'); // 調用 setUI 方法，將介面設置為 'editForm2'
		},
		setUI: function(page) {
			this.UI=page;
			this.loadList();//載入列表
		},
		setUI1: function(page) {
			this.UI=page;
			this.loadshoppingList();
		}
		
	},
	created() {
<<<<<<< HEAD
		this.loadList();
		// setInterval(this.fetchTotalPrice, 3000);
=======
		this.loadList();//初始化專案列表
>>>>>>> 5d68c5a3aa31f80b5a322f5b09a0c7d0a3d09147
	}
}).mount("#main");
</script>
</body>
</html>